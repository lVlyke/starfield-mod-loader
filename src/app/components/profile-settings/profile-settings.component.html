<form #profileForm="ngForm" id="profile-form" (ngSubmit)="submitForm(profileForm)">
    <div>
        <mat-checkbox name="baseProfileMode"
                      [disabled]="!createMode"
                      [ngModelOptions]="{ standalone: true }"
                      [(ngModel)]="baseProfileMode">
            Base Profile
            <mat-icon class="tooltip-icon" matTooltip="Base profile are limited profiles that can be extended by other profiles.">help</mat-icon>
        </mat-checkbox>
    </div>

    <mat-form-field appearance="fill">
        <mat-label>Game</mat-label>
        <mat-select name="gameId"
                    [required]="true"
                    [disabled]="!createMode || !!initialProfile.gameId"
                    [ngModel]="initialProfile.gameId ?? GameId.STARFIELD">
            @if (!!formModel) {
                <mat-select-trigger>
                    <app-game-badge [gameId]="formModel.gameId!" />
                </mat-select-trigger>
            }
            @for (gameId of gameIds; track gameId) {
                <mat-option [value]="gameId">
                    <app-game-badge [gameId]="gameId" />
                </mat-option>
            }
        </mat-select>
    </mat-form-field>

    <mat-form-field appearance="fill">
        <mat-label>Profile Name</mat-label>
        <input #nameModel="ngModel"
                matInput
                name="name"
                type="text"
                [required]="true"
                [disabled]="!createMode"
                [readonly]="!createMode"
                [ngModel]="initialProfile.name">
        @if ((nameModel.control.statusChanges | async) && nameModel.hasError("invalidProfileName")) {
            <mat-hint [attr.matWarn]="true">
                Profile already exists
            </mat-hint>
        }
    </mat-form-field>

    @if (!baseProfileMode) {
        <mat-form-field appearance="fill">
            <mat-label>Base Profile</mat-label>
            <mat-select #baseProfileModel="ngModel"
                        name="baseProfile"
                        [ngModel]="initialProfile.baseProfile?.name">
                <mat-select-trigger>{{ baseProfileModel.value }}</mat-select-trigger>
                @for (profileDesc of appProfileDescs; track profileDesc.name) {
                    @if (profileDesc.name !== formModel.name && (showAllBaseProfiles.checked || profileDesc.gameId === formModel.gameId || profileDesc.gameId === '$none')) {
                        <mat-option [value]="profileDesc.name">
                            @if (showAllBaseProfiles.checked) {
                                <app-game-badge [gameId]="profileDesc.gameId" />
                            }
                            {{ profileDesc.name }}
                        </mat-option>
                    }
                }
            </mat-select>

            <div matSuffix class="base-profile-select-all-charm" (click)="$event.stopPropagation()">
                <mat-checkbox #showAllBaseProfiles>Show all profiles</mat-checkbox>
            </div>
        </mat-form-field>
    }

    @let stdFieldInput = { formModel, form, baseProfileMode, modLinkModeSupported, configLinkModeSupported };
    @for (fieldEntry of stdFieldInput | appProfileSettingsStandardPathFields; track fieldEntry.formId) {
        @if (isFieldGroup(fieldEntry)) {
            <mat-expansion-panel>
                <mat-expansion-panel-header>
                    {{ fieldEntry.groupTitle }}
                    @if (fieldEntry.hint) {
                        <mat-icon class="tooltip-icon"
                                  [matTooltip]="fieldEntry.hint">
                            help
                        </mat-icon>
                    }
                </mat-expansion-panel-header>
            
                @for (fieldInfo of fieldEntry.fields; track fieldInfo.formId) {
                    <ng-container *ngTemplateOutlet="formFieldTemplate; context: { $implicit: fieldInfo }" />
                }
            </mat-expansion-panel>
        } @else {
            <ng-container *ngTemplateOutlet="formFieldTemplate; context: { $implicit: fieldEntry }" />
        }

        <ng-template #formFieldTemplate let-fieldInfo >
            <mat-form-field appearance="fill">
                <mat-label>{{ fieldInfo.title }}</mat-label>

                @if (fieldInfo.linkable) {
                    <button mat-icon-button 
                            matPrefix
                            type="button"
                            [attr.editable]="fieldInfo.linkFn"
                            [disabledInteractive]="!fieldInfo.linkFn"
                            [disabled]="!profileForm.enabled"
                            [color]="fieldInfo.linked ? 'accent' : null"
                            (click)="fieldInfo.linkFn ? fieldInfo.linkFn(fieldInfo) : null; $event.stopPropagation()">
                        <mat-icon>{{ fieldInfo.linked ? "link" : "link_off" }}</mat-icon>
                    </button>
                }

                <input #fieldModel="ngModel"
                    matInput
                    type="text"
                    [name]="fieldInfo.formId"
                    [required]="fieldInfo.requiredFn ? fieldInfo.requiredFn(formModel) : fieldInfo.required"
                    [ngModel]="$any(initialProfile)[fieldInfo.formId]"
                    cdkTrapFocus [cdkTrapFocusAutoCapture]="remedyMode === fieldModel.name">
        
                    @let defaultPath = $any(defaultPaths)?.[fieldInfo.formId];
                    @if (!!defaultPath) {
                        <button mat-icon-button 
                                matSuffix
                                type="button"
                                color="accent"
                                matTooltip="Reset to Default Value"
                                [disabled]="!profileForm.enabled"
                                [attr.hidden]="!fieldInfo.path || null"
                                (click)="fieldModel.control.setValue(defaultPath); $event.stopPropagation()">
                            <mat-icon>refresh</mat-icon>
                        </button>
                    }
        
                <button mat-icon-button 
                        matSuffix
                        type="button"
                        color="accent"
                        matTooltip="Choose {{ fieldInfo.fileTypes ? 'File' : 'Directory' }}"
                        [disabled]="!profileForm.enabled"
                        [attr.hidden]="!fieldInfo.path || null"
                        (click)="choosePath(fieldModel, fieldInfo.fileTypes); $event.stopPropagation()">
                    <mat-icon>folder</mat-icon>
                </button>

                @if (fieldInfo.hint) {
                    <mat-icon matSuffix
                              [matTooltip]="fieldInfo.hint">
                        help
                    </mat-icon>
                }

                @if (fieldModel.errors?.["invalidProfileRoot"]) {
                    <mat-error>
                        Invalid directory
                    </mat-error>
                }
            </mat-form-field>
        </ng-template>
    }

    @if (!baseProfileMode) {
        <div class="checkbox-field">
            <mat-checkbox name="modLinkMode"
                        [disabled]="!profileForm.enabled || !modLinkModeSupported"
                        [ngModel]="modLinkModeSupported ? (initialProfile.modLinkMode ?? true) : false">
                Link Mode
            </mat-checkbox>

            <mat-icon class="tooltip-icon" matTooltip="Deploy file links instead of copying files (much faster)">help</mat-icon>

            @if (!modLinkModeSupported) {
                @if (modLinkModeChildOnlySupported) {
                    <mat-icon class="tooltip-icon"
                            matInfo
                            matTooltip="Link mode cannot be enabled with base profile '{{formModel.baseProfile}}'">
                        warning
                    </mat-icon>
                } @else {
                    <mat-icon class="tooltip-icon"
                            matInfo
                            matTooltip="Link mode not supported for this profile">
                        warning
                    </mat-icon>
                }
            }
        </div>
    }

    @if (!baseProfileMode && formModel.manageConfigFiles) {
        <div class="checkbox-field">
            <mat-checkbox name="configLinkMode"
                        [attr.app-hidden]="true"
                        [disabled]="!profileForm.enabled || !configLinkModeSupported"
                        [ngModel]="configLinkModeSupported ? (initialProfile.configLinkMode ?? true) : false">
                Config Link Mode
            </mat-checkbox>
        </div>
    }

    <div class="checkbox-field">
        <mat-checkbox name="manageConfigFiles"
                      [disabled]="!profileForm.enabled"
                      [ngModel]="initialProfile.manageConfigFiles">
            Manage Config/INI Files
            <mat-icon class="tooltip-icon" matTooltip="Create profile-specific INI files. Existing INI files are used if this is disabled.">help</mat-icon>
        </mat-checkbox>
    </div>

    @if (!baseProfileMode) {
        <div class="checkbox-field">
            <mat-checkbox name="manageSaveFiles"
                          [disabled]="!profileForm.enabled || !manageSavesSupported"
                          [ngModel]="manageSavesSupported ? initialProfile.manageSaveFiles : false">
                Manage Save Files
                <mat-icon class="tooltip-icon" matTooltip="Manage save games so they are part of the profile and only active if the profile is active.">help</mat-icon>
            </mat-checkbox>
        </div>
    }

    @if (!baseProfileMode && manageSteamCompatSymlinksSupported) {
        <div class="checkbox-field">
            <mat-checkbox name="manageSteamCompatSymlinks"
                          [disabled]="!profileForm.enabled"
                          [ngModel]="manageSteamCompatSymlinksSupported ? initialProfile.manageSteamCompatSymlinks : false">
                Manage Steam Compat Symlinks
                <mat-icon class="tooltip-icon" matTooltip="Automatically create symlinks that synchronize game data for your custom Steam game entry.">help</mat-icon>
            </mat-checkbox>
        </div>
    }

    @if (!baseProfileMode) {
        @let gameDetails = gameDb[formModel.gameId!];
        @if (gameDetails?.archiveInvalidation) {
            <div class="checkbox-field">
                <mat-checkbox [disabled]="!profileForm.enabled || createMode || !(formModel.manageConfigFiles || (gameDetails | appGameConfigFilesFound$ | async))"
                              [checked]="'profile:checkArchiveInvalidationEnabled' | appSendElectronMsg$:{ profile: $any(formModel) } | async"
                              (change)="profileManager.setArchiveInvalidationEnabled($event.checked)">
                    Archive Invalidation
                </mat-checkbox>

                @if (createMode) {
                    <mat-icon class="tooltip-icon"
                              matTooltip="This setting can only be modified after the profile has been created.">
                        help
                    </mat-icon>
                }
            </div>
        }
    }
</form>